<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Financeiro</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* Global */
  body { margin:0; font-family: 'Inter', sans-serif; background:#f4f4f8; color:#212529; transition: background 0.3s, color 0.3s; }
  .hidden { display:none; }
  .container { max-width:1200px; margin:20px auto; padding:20px; }

  /* HEADER */
  header { display:flex; justify-content: space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
  h1 { color:#2c3e50; font-size:1.8rem; font-weight:700; }
  .theme-toggle, #btn-logout { width:40px; height:40px; border:none; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition: all 0.3s; }
  .theme-toggle { background-color:#ecf0f1; color:#2c3e50; }
  .theme-toggle:hover { background-color:#2c3e50; color:white; }
  #btn-logout { background-color:#e74c3c; color:white; }
  #btn-logout:hover { background-color:#c0392b; }

  /* RESUMO */
  .resumo-financeiro { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom:20px; }
  .resumo-item { background:white; padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
  .resumo-item:hover { transform: translateY(-4px); }
  .resumo-item h3 { margin-bottom:10px; font-weight:600; }
  .saldo p { color:#2c3e50; font-size:1.8rem; font-weight:700; }
  .receitas p { color:#27ae60; font-size:1.8rem; font-weight:700; }
  .despesas p { color:#e74c3c; font-size:1.8rem; font-weight:700; }

  /* TABELA */
  table { width:100%; border-collapse:collapse; }
  th, td { padding:12px; }
  th { background-color:#ecf0f1; text-transform:uppercase; font-size:0.85rem; font-weight:600; text-align:left; }
  tr:nth-child(even){ background-color:#f9f9f9; }
  .receita { color:#27ae60; font-weight:600; }
  .despesa { color:#e74c3c; font-weight:600; }
  button.excluir { background:#e74c3c; color:white; border:none; padding:6px 10px; cursor:pointer; border-radius:5px; transition: background 0.2s; }
  button.excluir:hover { background:#c0392b; }

  /* FORM */
  #form-nova-transacao { display:none; background:white; padding:20px; border-radius:12px; margin-top:20px; box-shadow:0 4px 10px rgba(0,0,0,0.05); transform: translateY(20px); opacity:0; transition: all 0.3s; }
  #form-nova-transacao.show { display:block; opacity:1; transform: translateY(0); }
  .form-container { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
  .form-buttons { grid-column:span 2; display:flex; justify-content:flex-end; gap:10px; margin-top:10px; }
  input, select { padding:10px; border-radius:5px; border:1px solid #ccc; width:100%; }
  button[type="submit"], #cancelar-transacao { padding:10px 15px; border:none; border-radius:5px; cursor:pointer; transition: all 0.2s; }
  button[type="submit"]{ background:#2c3e50; color:white; }
  button[type="submit"]:hover { background:#34495e; }
  #cancelar-transacao{ background:#bdc3c7; color:white; }
  #cancelar-transacao:hover { background:#95a5a6; }

  /* LOGIN */
  #auth-container { max-width:400px; margin:50px auto; padding:20px; background:white; border-radius:12px; box-shadow:0 10px 25px rgba(0,0,0,0.1); text-align:center; transition: all 0.3s; }
  #auth-container input { width:100%; margin:8px 0; padding:10px; border-radius:5px; border:1px solid #ccc; }
  #auth-container button { width:100%; padding:10px; margin-top:10px; background:#2c3e50; color:white; border:none; cursor:pointer; border-radius:5px; transition: all 0.2s; }
  #auth-container button:hover { background:#34495e; }
  #auth-toggle { margin-top:10px; cursor:pointer; color:#2c3e50; text-decoration:underline; }
  .notification { display:none; padding:10px; margin-top:10px; border-radius:5px; font-weight:600; }
  .notification.success { background:#27ae60; color:white; }
  .notification.error { background:#e74c3c; color:white; }

  /* DARK MODE */
  body.dark { background:#2c3e50; color:#ecf0f1; }
  body.dark #auth-container, body.dark .container, body.dark #form-nova-transacao { background:#34495e; color:#ecf0f1; }
  body.dark input, body.dark select { background:#2c3e50; color:#ecf0f1; border:1px solid #7f8c8d; }
  body.dark th { background:#7f8c8d; color:#ecf0f1; }
  body.dark .resumo-item { background:#34495e; color:#ecf0f1; }
  body.dark button[type="submit"]{ background:#27ae60; }
  body.dark button[type="submit"]:hover { background:#2ecc71; }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="auth-container">
  <h2 id="auth-title">Registrar</h2>
  <input type="email" id="auth-email" placeholder="Email">
  <input type="password" id="auth-password" placeholder="Senha">
  <button id="auth-button">Registrar</button>
  <p id="auth-toggle">Já tem conta? Entrar</p>
  <div id="notification" class="notification"></div>
</div>

<!-- DASHBOARD -->
<div class="container hidden" id="dashboard">
  <button id="btn-logout" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
  <header>
    <h1>Dashboard Financeiro</h1>
    <button class="theme-toggle" id="theme-toggle" title="Alterar tema"><i class="fas fa-moon"></i></button>
  </header>

  <div class="resumo-financeiro">
    <div class="resumo-item saldo card"><h3>Saldo Atual</h3><p id="saldo-atual">R$0,00</p></div>
    <div class="resumo-item receitas card"><h3>Receitas</h3><p id="total-receitas">R$0,00</p></div>
    <div class="resumo-item despesas card"><h3>Despesas</h3><p id="total-despesas">R$0,00</p></div>
  </div>

  <div class="card grafico-container"><canvas id="grafico-financeiro"></canvas></div>

  <div class="card transacoes">
    <table>
      <thead><tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Valor</th><th>Ações</th></tr></thead>
      <tbody id="corpo-tabela"><tr><td colspan="5" style="text-align:center;">Nenhuma transação encontrada</td></tr></tbody>
    </table>
  </div>

  <div class="card" id="form-nova-transacao">
    <form id="form-transacao">
      <div class="form-container">
        <input type="date" id="data" required>
        <input type="text" id="descricao" placeholder="Descrição" required>
        <input type="text" id="categoria" placeholder="Categoria" required>
        <input type="number" id="valor" placeholder="Valor" step="0.01" min="0" required>
        <select id="tipo" required>
          <option value="receita">Receita</option>
          <option value="despesa">Despesa</option>
        </select>
      </div>
      <div class="form-buttons">
        <button type="submit"><i class="fas fa-check"></i> Adicionar</button>
        <button type="button" id="cancelar-transacao"><i class="fas fa-times"></i> Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAh6NmfvbT3zFZDuJAAH7fG-0qBFzR3pMc",
  authDomain: "guga-b7022.firebaseapp.com",
  databaseURL: "https://guga-b7022-default-rtdb.firebaseio.com",
  projectId: "guga-b7022",
  storageBucket: "guga-b7022.firebasestorage.app",
  messagingSenderId: "730764999252",
  appId: "1:730764999252:web:31c9506021dad2604e8bc1",
  measurementId: "G-XRLME6Y4QH"
};
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);
const transacoesRef = ref(database, 'transacoes');

// DOM
const authContainer = document.getElementById('auth-container');
const dashboard = document.getElementById('dashboard');
const authTitle = document.getElementById('auth-title');
const authButton = document.getElementById('auth-button');
const authToggle = document.getElementById('auth-toggle');
const authEmail = document.getElementById('auth-email');
const authPassword = document.getElementById('auth-password');
const btnLogout = document.getElementById('btn-logout');
const notification = document.getElementById('notification');
const themeToggle = document.getElementById('theme-toggle');
const formNova = document.getElementById('form-nova-transacao');
const cancelarTrans = document.getElementById('cancelar-transacao');

let todasTransacoes = [];
let grafico = null;
let currentUser = null;
let isRegister = true;

// DARK MODE
themeToggle.addEventListener('click', () => document.body.classList.toggle('dark'));

// Alternar registro/login
authToggle.addEventListener('click', () => {
  isRegister = !isRegister;
  authTitle.textContent = isRegister ? "Registrar" : "Entrar";
  authButton.textContent = isRegister ? "Registrar" : "Entrar";
  authToggle.textContent = isRegister ? "Já tem conta? Entrar" : "Não tem conta? Registrar";
  authEmail.value = '';
  authPassword.value = '';
  notification.style.display='none';
});

// Notificação
function showNotification(msg,isSuccess=true){
  notification.textContent=msg;
  notification.className=`notification ${isSuccess?'success':'error'}`;
  notification.style.display='block';
  setTimeout(()=>notification.style.display='none',3000);
}

// Registrar/Login
authButton.addEventListener('click', async ()=>{
  const email = authEmail.value.trim();
  const password = authPassword.value.trim();
  if(isRegister && password.length <6){ showNotification('Senha mínima: 6 caracteres',false); return; }
  try{
    if(isRegister) await createUserWithEmailAndPassword(auth,email,password);
    else await signInWithEmailAndPassword(auth,email,password);
    showNotification(isRegister ? 'Registrado com sucesso!' : 'Login realizado!');
    authEmail.value='';
    authPassword.value='';
  }catch(err){ showNotification(err.message,false);}
});

// Logout
btnLogout.addEventListener('click', async ()=>{ try{ await signOut(auth); showNotification('Usuário deslogado!'); }catch(e){ showNotification('Erro ao deslogar',false); } });

// Monitorar usuário
onAuthStateChanged(auth,user=>{
  currentUser=user;
  if(user){
    authContainer.classList.add('hidden');
    dashboard.classList.remove('hidden');
    carregarTransacoes();
  }else{
    authContainer.classList.remove('hidden');
    dashboard.classList.add('hidden');
    todasTransacoes=[];
    document.getElementById('corpo-tabela').innerHTML='<tr><td colspan="5" style="text-align:center;">Nenhuma transação encontrada</td></tr>';
    document.getElementById('saldo-atual').textContent='R$0,00';
    document.getElementById('total-receitas').textContent='R$0,00';
    document.getElementById('total-despesas').textContent='R$0,00';
    if(grafico) grafico.destroy();
  }
});

// Carregar transações
function carregarTransacoes(){
  onValue(transacoesRef, snapshot=>{
    const dados = snapshot.val()||{};
    todasTransacoes = Object.entries(dados).map(([id,t])=>({id,...t}));
    atualizarDashboard();
  });
}

// Atualizar dashboard
function atualizarDashboard(){
  const saldo = todasTransacoes.reduce((s,t)=>t.tipo==='receita'?s+parseFloat(t.valor):s-parseFloat(t.valor),0);
  const totalReceitas = todasTransacoes.filter(t=>t.tipo==='receita').reduce((s,t)=>s+parseFloat(t.valor),0);
  const totalDespesas = todasTransacoes.filter(t=>t.tipo==='despesa').reduce((s,t)=>s+parseFloat(t.valor),0);

  document.getElementById('saldo-atual').textContent=saldo.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  document.getElementById('total-receitas').textContent=totalReceitas.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  document.getElementById('total-despesas').textContent=totalDespesas.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

  const tbody=document.getElementById('corpo-tabela'); tbody.innerHTML='';
  if(todasTransacoes.length===0){ tbody.innerHTML='<tr><td colspan="5" style="text-align:center;">Nenhuma transação encontrada</td></tr>'; }
  else{
    todasTransacoes.forEach(t=>{
      const tr=document.createElement('tr');
      const dataFormat=new Date(t.data).toLocaleDateString('pt-BR');
      const valorExibido = t.tipo==='despesa'? -Math.abs(parseFloat(t.valor)) : parseFloat(t.valor);
      tr.innerHTML=`
        <td>${dataFormat}</td>
        <td>${t.descricao}</td>
        <td>${t.categoria}</td>
        <td class="${t.tipo==='receita'?'receita':'despesa'}">${valorExibido.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
        <td><button class="excluir" data-id="${t.id}"><i class="fas fa-trash"></i></button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.querySelectorAll('.excluir').forEach(btn=>{
    btn.addEventListener('click', async e=>{
      const id=e.target.getAttribute('data-id');
      if(confirm('Deseja excluir esta transação?')) await remove(ref(database,`transacoes/${id}`));
    });
  });

  const ctx=document.getElementById('grafico-financeiro').getContext('2d');
  if(grafico) grafico.destroy();
  grafico=new Chart(ctx,{type:'doughnut',data:{labels:['Receitas','Despesas'],datasets:[{data:[totalReceitas,totalDespesas],backgroundColor:['#27ae60','#e74c3c']}]}, options:{responsive:true}});
}

// Adicionar transação
document.getElementById('form-transacao').addEventListener('submit',async e=>{
  e.preventDefault();
  const data=document.getElementById('data').value;
  const descricao=document.getElementById('descricao').value;
  const categoria=document.getElementById('categoria').value;
  const valor=parseFloat(document.getElementById('valor').value);
  const tipo=document.getElementById('tipo').value;
  await push(transacoesRef,{data,descricao,categoria,valor,tipo});
  document.getElementById('form-transacao').reset();
});

// Mostrar/ocultar formulário
document.getElementById('saldo-atual').parentElement.addEventListener('click',()=> formNova.classList.toggle('show'));
cancelarTrans.addEventListener('click',()=> formNova.classList.remove('show'));
</script>
</body>
</html>